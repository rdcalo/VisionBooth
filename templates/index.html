<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobooth - VisionBooth</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #f1f1f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #101b40;
            overflow-x: hidden;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 35px 90px;
            background-color: #f1f1f1;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.2em;
            font-weight: 700;
            color: #101b40;
            letter-spacing: 0.5px;
            text-align: left;
            line-height: 1.2;
        }

        .logo span {
            display: block;
        }

        .nav-menu {
            background-color: #f1f1f1;
            border: 2.5px solid #101b40;
            border-radius: 50px;
            padding: 6px;
            display: flex;
            gap: 5px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 3px 12px rgba(16, 27, 64, 0.12);
        }

        .nav-btn {
            padding: 10px 32px;
            border: none;
            border-radius: 50px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #101b40;
            text-decoration: none;
        }

        .nav-btn.active {
            background-color: #101b40;
            color: white;
        }

        .nav-btn:hover:not(.active) {
            background-color: #e6e6e6;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 30px 20px 50px;
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .status-title {
            font-size: 2.2em;
            font-weight: 700;
            color: #101b40;
            margin-bottom: 20px;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 850px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin: 0;
            border: 6px solid #101b40;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        #video, #processedFrame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        #processedFrame {
            display: none;
        }

        .countdown-display {
            font-size: 6em;
            font-weight: 800;
            color: #101b40;
            margin: 5px 0 5px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-section {
            margin-top: 5px;
        }

        .info-text {
            font-size: 1.4em;
            font-weight: 600;
            color: #101b40;
            margin-bottom: 8px;
        }

        .action-btn {
            padding: 15px 45px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 50px;
            background-color: #101b40;
            color: #fff;
            border: 3px solid #101b40;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(16,27,64,0.25);
            margin-top: 5px;
        }

        .action-btn:hover {
            background-color: white;
            color: #101b40;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16,27,64,0.3);
        }

        .gesture-display {
            font-size: 1em;
            color: #333;
            margin-top: 8px;
            font-weight: 500;
        }

        .progress-bar-container {
            width: 100%;
            max-width: 500px;
            margin: 10px auto;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #ddd;
            border-radius: 50px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: #101b40;
            border-radius: 50px;
            transition: width 0.3s ease;
        }

        .strip-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #f1f1f1;
            z-index: 999;
        }

        .strip-preview.show {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 80px;
            padding: 40px;
        }

        .strip-container {
            flex-shrink: 0;
        }

        .strip-preview img {
            display: block;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-height: 85vh;
            width: auto;
            height: auto;
        }

        .completion-content {
            flex-shrink: 0;
            text-align: left;
            max-width: 600px;
        }

        .thank-you-text {
            font-size: 1.5em;
            font-weight: 400;
            color: #101b40;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        .visionbooth-title {
            font-size: 5em;
            font-weight: 800;
            color: #101b40;
            margin-bottom: 25px;
            line-height: 1;
            letter-spacing: -1px;
        }

        .ready-text {
            font-size: 1.5em;
            font-weight: 400;
            color: #101b40;
            margin-bottom: 40px;
            letter-spacing: 0.3px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 18px;
            align-items: flex-start;
        }

        .download-btn {
            padding: 18px 60px;
            font-size: 1.15em;
            font-weight: 600;
            border-radius: 50px;
            background-color: transparent;
            color: #101b40;
            border: 2.5px solid #101b40;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 240px;
        }

        .download-btn:hover {
            background-color: #101b40;
            color: white;
            transform: translateX(8px);
        }

        .performance-info {
            font-size: 0.9em;
            color: #777;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 1024px) {
            .strip-preview.show {
                flex-direction: column;
                gap: 40px;
                justify-content: center;
            }

            .strip-preview img {
                width: 240px;
            }

            .completion-content {
                text-align: center;
            }

            .visionbooth-title {
                font-size: 3.5em;
            }

            .button-group {
                align-items: center;
                width: 100%;
            }

            .download-btn {
                width: 100%;
                max-width: 320px;
            }
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                padding: 20px 30px;
            }

            .nav-menu {
                position: static;
                transform: none;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 10px;
            }

            .nav-btn {
                padding: 10px 25px;
                font-size: 0.9em;
            }

            .status-title {
                font-size: 1.6em;
            }

            .countdown-display {
                font-size: 3.5em;
                min-height: 60px;
            }

            .strip-preview img {
                width: 200px;
            }

            .thank-you-text {
                font-size: 1.2em;
            }

            .visionbooth-title {
                font-size: 2.5em;
            }

            .ready-text {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="logo">
            <span>VISION</span>
            <span>BOOTH</span>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-btn">HOME</a>
            <a href="/guide" class="nav-btn">GUIDE</a>
            <a href="/index" class="nav-btn active">PHOTOBOOTH</a>
            <a href="/about" class="nav-btn">ABOUT</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <h1 class="status-title" id="statusTitle">Set your timer using your fingers</h1>

        <div id="videoContainer">
            <video id="video" autoplay playsinline></video>
            <img id="processedFrame" alt="Processed frame">
        </div>

        <div class="countdown-display" id="countdownDisplay"></div>

        <div class="info-section">
            <p class="info-text" id="infoText">Do a thumbs up when you're ready!</p>
            <button class="action-btn hidden" id="resetBtn" onclick="resetSession()">Make a fist to change timer</button>
        </div>

        <div class="progress-bar-container hidden" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <p class="gesture-display" id="gestureDisplay">Gesture detected: None</p>

        <p class="performance-info" id="performanceInfo">FPS: --</p>
    </div>

    <div class="strip-preview" id="stripPreview">
        <div class="strip-container">
            <img id="stripImage" src="" alt="Photo strip">
        </div>
        <div class="completion-content">
            <p class="thank-you-text">Thank you for trying out</p>
            <h2 class="visionbooth-title">VisionBooth</h2>
            <p class="ready-text">Your photo strip is ready to download!</p>
            <div class="button-group">
                <button class="download-btn" onclick="downloadStrip()">DOWNLOAD</button>
                <button class="download-btn" onclick="startNewStrip()">RETAKE</button>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const socket = io();
        const video = document.getElementById('video');
        const processedFrame = document.getElementById('processedFrame');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusTitle = document.getElementById('statusTitle');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const infoText = document.getElementById('infoText');
        const resetBtn = document.getElementById('resetBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const gestureDisplay = document.getElementById('gestureDisplay');
        const performanceInfo = document.getElementById('performanceInfo');
        const stripPreview = document.getElementById('stripPreview');
        const stripImage = document.getElementById('stripImage');

        let canSend = true;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let currentState = 'PROMPT_TIMER';
        let processingTimeout = null;
        let lastFrameTime = 0;
        let currentStripFilename = null;
        let lastCaptureTriggered = false;

        const SCALE_FACTOR = 0.35;
        const JPEG_QUALITY = 0.5;
        const FRAME_INTERVAL = 200;
        const RESPONSE_TIMEOUT = 2000;

        // Access webcam
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                facingMode: 'user'
            } 
        })
        .then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth * SCALE_FACTOR;
                canvas.height = video.videoHeight * SCALE_FACTOR;
                
                console.log(`Video Resolution: ${video.videoWidth}x${video.videoHeight}`);
                console.log(`Detection Resolution: ${canvas.width}x${canvas.height}`);
                
                startSending();
            };
        })
        .catch(err => {
            console.error('Error accessing camera:', err);
            statusTitle.textContent = 'Error: Cannot access camera';
        });

        function startSending() {
            setInterval(() => {
                const now = Date.now();
                
                if (now - lastFrameTime < FRAME_INTERVAL) {
                    return;
                }
                
                if (canSend) {
                    canSend = false;
                    lastFrameTime = now;
                    
                    if (processingTimeout) {
                        clearTimeout(processingTimeout);
                    }
                    
                    processingTimeout = setTimeout(() => {
                        console.warn('Backend timeout, forcing reset');
                        canSend = true;
                    }, RESPONSE_TIMEOUT);
                    
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
                    
                    socket.emit('video_frame', { image: imageData });
                    updateFPS();
                }
            }, 50);
        }

        function updateFPS() {
            frameCount++;
            const now = Date.now();
            const elapsed = now - lastFpsUpdate;
            
            if (elapsed >= 1000) {
                const fps = Math.round((frameCount / elapsed) * 1000);
                performanceInfo.textContent = `FPS: ${fps} | Detection: ${canvas.width}x${canvas.height} | Capture: ${video.videoWidth}x${video.videoHeight}`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        socket.on('state_update', (data) => {
            if (processingTimeout) {
                clearTimeout(processingTimeout);
                processingTimeout = null;
            }
            
            canSend = true;
            
            const stateChanged = (currentState !== data.state);
            currentState = data.state;
            
            if (stateChanged && currentState !== 'CAPTURE_DONE') {
                lastCaptureTriggered = false;
            }
            
            if (data.trigger_capture === true && !lastCaptureTriggered) {
                console.log('Capture triggered by state update');
                lastCaptureTriggered = true;
                setTimeout(() => capturePhoto(), 100);
            }
            
            if (currentState !== 'COUNTDOWN' && data.frame) {
                processedFrame.src = data.frame;
                processedFrame.style.display = 'block';
                video.style.display = 'block';
            } else {
                processedFrame.style.display = 'none';
                video.style.display = 'block';
            }
            
            if (data.gesture) {
                gestureDisplay.textContent = `Gesture detected: ${data.gesture}`;
            } else {
                gestureDisplay.textContent = 'Gesture detected: None';
            }
            
            updateStatus(data);
        });

        function updateStatus(data) {
            const { state, timer_value, countdown: countdownValue, streak_progress, capture_count, total_captures } = data;
            
            countdownDisplay.textContent = '';
            progressContainer.classList.add('hidden');
            resetBtn.classList.add('hidden');
            
            switch(state) {
                case 'PROMPT_TIMER':
                    statusTitle.textContent = 'Set your timer using your fingers';
                    infoText.textContent = 'Do a thumbs up when you\'re ready!';
                    break;
                    
                case 'DETECTING_FINGERS':
                    statusTitle.textContent = 'Hold steady...';
                    infoText.textContent = 'Do a thumbs up when you\'re ready!';
                    if (streak_progress) {
                        progressContainer.classList.remove('hidden');
                        const percent = (streak_progress.current / streak_progress.required) * 100;
                        progressFill.style.width = percent + '%';
                    }
                    break;
                    
                case 'TIMER_SET':
                case 'AWAIT_THUMBS_UP':
                    statusTitle.textContent = `Timer set to ${timer_value} seconds`;
                    infoText.textContent = 'Do a thumbs up when you\'re ready!';
                    resetBtn.classList.remove('hidden');
                    if (streak_progress) {
                        progressContainer.classList.remove('hidden');
                        const percent = (streak_progress.current / streak_progress.required) * 100;
                        progressFill.style.width = percent + '%';
                    }
                    break;
                    
                case 'COUNTDOWN':
                    if (countdownValue !== null && countdownValue !== undefined) {
                        if (countdownValue > 0) {
                            statusTitle.textContent = '';
                            countdownDisplay.textContent = countdownValue;
                            infoText.textContent = 'Pose and hold still! Taking your photos!';
                        } else {
                            statusTitle.textContent = '';
                            countdownDisplay.textContent = '.';
                            infoText.textContent = 'Smile!';
                        }
                    }
                    resetBtn.classList.remove('hidden');
                    break;
                    
                case 'CAPTURE_DONE':
                    if (capture_count < total_captures) {
                        statusTitle.textContent = `Photo ${capture_count}/${total_captures} captured!`;
                        infoText.textContent = 'Get ready for next photo...';
                    } else {
                        statusTitle.textContent = 'Creating your photo strip...';
                        infoText.textContent = 'Almost done!';
                    }
                    break;
            }
        }

        function capturePhoto() {
            console.log('Capture photo function called');
            
            try {
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const captureCtx = captureCanvas.getContext('2d');
                
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                const imageData = captureCanvas.toDataURL('image/png');
                
                console.log(`Image captured at ${captureCanvas.width}x${captureCanvas.height}`);
                
                socket.emit('save_photo', { image: imageData });
                console.log('Sent photo to server for saving');
            } catch (error) {
                console.error('Error capturing photo:', error);
            }
        }

        socket.on('strip_ready', (data) => {
            console.log('Strip ready:', data.filename);
            currentStripFilename = data.filename;
    
            const img = new Image();
            img.onload = function() {
                console.log(`Photo strip dimensions: ${img.naturalWidth}x${img.naturalHeight}`);
                stripImage.src = `/${data.filename}`;
                stripPreview.classList.add('show');
            };
            img.src = `/${data.filename}`;
        });

        socket.on('photo_received', (data) => {
            console.log(`Photo ${data.count}/${data.total} acknowledged by server`);
        });

        socket.on('photo_error', (data) => {
            console.error('Photo error:', data.error);
            statusTitle.textContent = `Error: ${data.error}`;
            infoText.textContent = 'Please try again';
        });

        function downloadStrip() {
            if (currentStripFilename) {
                const link = document.createElement('a');
                link.href = `/${currentStripFilename}`;
                link.download = currentStripFilename.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('Downloading strip');
            }
        }

        function startNewStrip() {
            stripPreview.classList.remove('show');
            console.log('Starting new strip');
            location.reload();
        }

        function resetSession() {
            console.log('Reset handled by fist gesture');
        }

        socket.on('connected', (data) => {
            console.log('Connected to server. Session:', data.session);
        });

        socket.on('disconnect', () => {
            console.warn('Disconnected from server');
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
        });

        socket.on('error', (error) => {
            console.error('Socket error:', error);
        });
    </script>
</body>
</html>
